<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç¡çœ è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ğŸ›Œ ç¡çœ è¨˜éŒ²ã‚¢ãƒ—ãƒª</h1>

  <!-- ä¿å­˜ãƒ»æ›´æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
  <% if (updated) { %>
    <div style="color: blue;">âœï¸ è¨˜éŒ²ãŒä¸Šæ›¸ãã•ã‚Œã¾ã—ãŸ</div>
  <% } %>
  <% if (saved) { %>
    <div style="color: green;">âœ… æ–°ã—ã„è¨˜éŒ²ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ</div>
  <% } %>

  <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæ–°è¦ã¾ãŸã¯ç·¨é›†ï¼‰ -->
  <form action="/sleep" method="POST">
    <% if (editData) { %>
      <input type="hidden" name="id" value="<%= editData.id %>">
    <% } %>
    <p><label>æ—¥ä»˜: <input type="date" name="date" value="<%= editData ? editData.date : '' %>" required></label></p>
    <p><label>å°±å¯: <input type="time" name="sleep_start" value="<%= editData ? editData.sleep_start : '' %>" required></label></p>
    <p><label>èµ·åºŠ: <input type="time" name="sleep_end" value="<%= editData ? editData.sleep_end : '' %>" required></label></p>
    <p><label>è³ªï¼ˆ1ã€œ5ï¼‰: <input type="number" name="sleep_quality" min="1" max="5" value="<%= editData ? editData.sleep_quality : '' %>" required></label></p>
    <p>
      <label><input type="checkbox" name="caffeine" value="1" <%= editData && editData.caffeine ? 'checked' : '' %>> ã‚«ãƒ•ã‚§ã‚¤ãƒ³</label>
      <label><input type="checkbox" name="smartphone" value="1" <%= editData && editData.smartphone ? 'checked' : '' %>> ã‚¹ãƒãƒ›</label>
      <label><input type="checkbox" name="exercise" value="1" <%= editData && editData.exercise ? 'checked' : '' %>> é‹å‹•</label>
    </p>
    <p><label>å°±å¯å‰ãƒ¡ãƒ¢: <input type="text" name="note" value="<%= editData ? editData.note : '' %>"></label></p>
    <button type="submit"><%= editData ? 'æ›´æ–°' : 'è¨˜éŒ²' %></button>
  </form>

  <!-- æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ• -->
  <h2>ğŸ“ˆ ç¡çœ ã®è³ªã®æ¨ç§»</h2>
  <canvas id="sleepChart" width="400" height="100"></canvas>

  <!-- é€±ãƒ»æœˆå¹³å‡ã‚°ãƒ©ãƒ• -->
  <h2>ğŸ“Š é€±ã”ã¨ã®å¹³å‡</h2>
  <canvas id="weeklyAvgChart" width="400" height="100"></canvas>

  <h2>ğŸ“Š æœˆã”ã¨ã®å¹³å‡</h2>
  <canvas id="monthlyAvgChart" width="400" height="100"></canvas>

  <!-- æœ€è¿‘ã®è¨˜éŒ²è¡¨ç¤º -->
  <h2>ğŸ“… æœ€è¿‘ã®è¨˜éŒ²</h2>
  <table border="1">
    <tr>
      <th>æ—¥ä»˜</th><th>å°±å¯</th><th>èµ·åºŠ</th><th>è³ª</th>
      <th>ã‚«ãƒ•ã‚§ã‚¤ãƒ³</th><th>ã‚¹ãƒãƒ›</th><th>é‹å‹•</th><th>ãƒ¡ãƒ¢</th><th>æ“ä½œ</th>
    </tr>
    <% history.forEach(item => { %>
      <tr>
        <td><%= item.date %></td>
        <td><%= item.sleep_start %></td>
        <td><%= item.sleep_end %></td>
        <td><%= item.sleep_quality %></td>
        <td><%= item.caffeine ? 'âœ…' : '' %></td>
        <td><%= item.smartphone ? 'âœ…' : '' %></td>
        <td><%= item.exercise ? 'âœ…' : '' %></td>
        <td><%= item.note %></td>
        <td>
          <form action="/edit/<%= item.id %>" method="GET" style="display:inline">
            <button type="submit">ç·¨é›†</button>
          </form>
          <form action="/delete/<%= item.id %>" method="POST" style="display:inline">
            <button type="submit">å‰Šé™¤</button>
          </form>
        </td>
      </tr>
    <% }) %>
  </table>

  <!-- Chart.js ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    // ç¡çœ ã®è³ªæ¨ç§»ï¼ˆå¤ã„é †ï¼‰
    const sortedHistory = <%- JSON.stringify(history) %>.sort((a, b) => new Date(a.date) - new Date(b.date));
    const labels = sortedHistory.map(item => item.date);
    const data = sortedHistory.map(item => item.sleep_quality);

    new Chart(document.getElementById('sleepChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'ç¡çœ ã®è³ª',
          data: data,
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            min: 0,
            max: 5
          }
        }
      }
    });

    // å¹³å‡ã‚°ãƒ©ãƒ•ï¼ˆé€±ãƒ»æœˆï¼‰
    const weekData = <%- JSON.stringify(weekAverages) %>;
    const monthData = <%- JSON.stringify(monthAverages) %>;

    new Chart(document.getElementById('weeklyAvgChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: weekData.map(d => d.label),
        datasets: [{
          label: 'é€±å¹³å‡',
          data: weekData.map(d => d.avg),
          backgroundColor: 'rgba(75, 192, 192, 0.4)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      }
    });

    new Chart(document.getElementById('monthlyAvgChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: monthData.map(d => d.label),
        datasets: [{
          label: 'æœˆå¹³å‡',
          data: monthData.map(d => d.avg),
          backgroundColor: 'rgba(255, 159, 64, 0.4)',
          borderColor: 'rgba(255, 159, 64, 1)',
          borderWidth: 1
        }]
      }
    });
  </script>
</body>
</html>
